# Spring Security + MyBatis + MySQL 회원관리 기능

## 1. 프로젝트 설정 수정

### build.gradle
```gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.3.1'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'mysql:mysql-connector-java:8.0.33'
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
}
```

## 2. 데이터베이스 스키마

### schema.sql
```sql
CREATE DATABASE IF NOT EXISTS spring_security_db;
USE spring_security_db;

CREATE TABLE IF NOT EXISTS users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS user_roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    role VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_role (user_id, role)
);

-- 초기 관리자 계정 (비밀번호: admin123)
INSERT INTO users (username, password, email, name) 
VALUES ('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTV2UiC', 'admin@example.com', 'Administrator');

INSERT INTO user_roles (user_id, role) 
VALUES (1, 'ADMIN'), (1, 'USER');
```

## 3. 도메인 모델

### User.java
```java
package com.example.security.entity;

import lombok.*;
import java.time.LocalDateTime;
import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class User {
    private Long id;
    private String username;
    private String password;
    private String email;
    private String name;
    private boolean enabled;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    @Builder.Default
    private List<String> roles = List.of("USER");
}
```

## 4. MyBatis Mapper 인터페이스

### UserMapper.java
```java
package com.example.security.mapper;

import com.example.security.entity.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;
import java.util.Optional;

@Mapper
public interface UserMapper {
    
    // 사용자 저장
    void save(User user);
    
    // 사용자명으로 조회
    Optional<User> findByUsername(String username);
    
    // 이메일로 조회
    Optional<User> findByEmail(String email);
    
    // ID로 조회
    Optional<User> findById(Long id);
    
    // 사용자명 존재 여부
    boolean existsByUsername(String username);
    
    // 이메일 존재 여부
    boolean existsByEmail(String email);
    
    // 사용자 역할 저장
    void saveUserRole(@Param("userId") Long userId, @Param("role") String role);
    
    // 사용자의 역할 목록 조회
    List<String> findRolesByUserId(Long userId);
    
    // 사용자의 역할 목록 조회 (사용자명으로)
    List<String> findRolesByUsername(String username);
    
    // 모든 사용자 조회
    List<User> findAll();
    
    // 사용자 정보 업데이트
    void update(User user);
    
    // 사용자 삭제
    void deleteById(Long id);
}
```

## 5. MyBatis Mapper XML

### src/main/resources/mapper/UserMapper.xml
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.security.mapper.UserMapper">

    <resultMap id="UserResultMap" type="com.example.security.entity.User">
        <id property="id" column="id" />
        <result property="username" column="username" />
        <result property="password" column="password" />
        <result property="email" column="email" />
        <result property="name" column="name" />
        <result property="enabled" column="enabled" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <collection property="roles" ofType="string" 
                   select="findRolesByUserId" column="id" />
    </resultMap>

    <insert id="save" parameterType="com.example.security.entity.User" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (username, password, email, name, enabled)
        VALUES (#{username}, #{password}, #{email}, #{name}, #{enabled})
    </insert>

    <select id="findByUsername" parameterType="string" resultMap="UserResultMap">
        SELECT id, username, password, email, name, enabled, created_at, updated_at
        FROM users
        WHERE username = #{username}
    </select>

    <select id="findByEmail" parameterType="string" resultMap="UserResultMap">
        SELECT id, username, password, email, name, enabled, created_at, updated_at
        FROM users
        WHERE email = #{email}
    </select>

    <select id="findById" parameterType="long" resultMap="UserResultMap">
        SELECT id, username, password, email, name, enabled, created_at, updated_at
        FROM users
        WHERE id = #{id}
    </select>

    <select id="existsByUsername" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM users
        WHERE username = #{username}
    </select>

    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM users
        WHERE email = #{email}
    </select>

    <insert id="saveUserRole">
        INSERT INTO user_roles (user_id, role)
        VALUES (#{userId}, #{role})
    </insert>

    <select id="findRolesByUserId" parameterType="long" resultType="string">
        SELECT role
        FROM user_roles
        WHERE user_id = #{userId}
    </select>

    <select id="findRolesByUsername" parameterType="string" resultType="string">
        SELECT ur.role
        FROM user_roles ur
        JOIN users u ON ur.user_id = u.id
        WHERE u.username = #{username}
    </select>

    <select id="findAll" resultMap="UserResultMap">
        SELECT id, username, password, email, name, enabled, created_at, updated_at
        FROM users
        ORDER BY created_at DESC
    </select>

    <update id="update" parameterType="com.example.security.entity.User">
        UPDATE users
        SET username = #{username},
            password = #{password},
            email = #{email},
            name = #{name},
            enabled = #{enabled},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <delete id="deleteById" parameterType="long">
        DELETE FROM users WHERE id = #{id}
    </delete>

</mapper>
```

## 6. Repository 계층 (MyBatis 기반)

### UserRepository.java
```java
package com.example.security.repository;

import com.example.security.entity.User;
import com.example.security.mapper.UserMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
@RequiredArgsConstructor
public class UserRepository {

    private final UserMapper userMapper;

    public User save(User user) {
        if (user.getId() == null) {
            userMapper.save(user);
            // 역할 저장
            if (user.getRoles() != null) {
                user.getRoles().forEach(role -> 
                    userMapper.saveUserRole(user.getId(), role));
            }
        } else {
            userMapper.update(user);
        }
        return user;
    }

    public Optional<User> findByUsername(String username) {
        return userMapper.findByUsername(username);
    }

    public Optional<User> findByEmail(String email) {
        return userMapper.findByEmail(email);
    }

    public Optional<User> findById(Long id) {
        return userMapper.findById(id);
    }

    public boolean existsByUsername(String username) {
        return userMapper.existsByUsername(username);
    }

    public boolean existsByEmail(String email) {
        return userMapper.existsByEmail(email);
    }

    public List<String> findRolesByUsername(String username) {
        return userMapper.findRolesByUsername(username);
    }

    public List<User> findAll() {
        return userMapper.findAll();
    }

    public void deleteById(Long id) {
        userMapper.deleteById(id);
    }
}
```

## 7. 서비스 계층

### UserService.java
```java
package com.example.security.service;

import com.example.security.entity.User;
import com.example.security.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
public class UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    @Transactional
    public User registerUser(User user) {
        // 중복 체크
        if (userRepository.existsByUsername(user.getUsername())) {
            throw new RuntimeException("이미 사용 중인 사용자명입니다.");
        }
        if (userRepository.existsByEmail(user.getEmail())) {
            throw new RuntimeException("이미 사용 중인 이메일입니다.");
        }

        // 비밀번호 암호화
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        
        // 기본 역할 설정
        if (user.getRoles() == null || user.getRoles().isEmpty()) {
            user.setRoles(List.of("USER"));
        }

        return userRepository.save(user);
    }

    public User findByUsername(String username) {
        return userRepository.findByUsername(username)
                .orElseThrow(() -> new RuntimeException("사용자를 찾을 수 없습니다: " + username));
    }

    public List<User> findAllUsers() {
        return userRepository.findAll();
    }

    @Transactional
    public void updateUser(User user) {
        User existingUser = userRepository.findById(user.getId())
                .orElseThrow(() -> new RuntimeException("사용자를 찾을 수 없습니다."));
        
        // 필요한 필드 업데이트
        existingUser.setName(user.getName());
        existingUser.setEmail(user.getEmail());
        if (user.getPassword() != null && !user.getPassword().isEmpty()) {
            existingUser.setPassword(passwordEncoder.encode(user.getPassword()));
        }
        
        userRepository.save(existingUser);
    }

    @Transactional
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
}
```

## 8. Security Configuration (수정 없음 - 동일)

### SecurityConfig.java
```java
package com.example.security.config;

import com.example.security.service.CustomUserDetailsService;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    private final CustomUserDetailsService userDetailsService;

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService)
            .passwordEncoder(passwordEncoder());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/", "/home", "/register", "/css/**", "/js/**").permitAll()
                .antMatchers("/user/**").hasRole("USER")
                .antMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
                .and()
            .formLogin()
                .loginPage("/login")
                .defaultSuccessUrl("/dashboard")
                .permitAll()
                .and()
            .logout()
                .logoutSuccessUrl("/")
                .permitAll()
                .and()
            .exceptionHandling()
                .accessDeniedPage("/access-denied");
    }
}
```

## 9. UserDetailsService (MyBatis 적용)

### CustomUserDetailsService.java
```java
package com.example.security.service;

import com.example.security.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        var user = userRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("사용자를 찾을 수 없습니다: " + username));

        var authorities = user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role))
                .collect(Collectors.toList());

        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getUsername())
                .password(user.getPassword())
                .authorities(authorities)
                .disabled(!user.isEnabled())
                .build();
    }
}
```

## 10. 애플리케이션 설정

### application.yml
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/spring_security_db?useSSL=false&serverTimezone=UTC&characterEncoding=UTF-8
    username: your_username
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  # MyBatis 설정
mybatis:
  mapper-locations: classpath:mapper/**/*.xml
  type-aliases-package: com.example.security.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# 로깅 설정
logging:
  level:
    com.example.security.mapper: DEBUG
    org.springframework.security: DEBUG
```

## 11. 테스트 데이터 생성기

### TestDataInitializer.java
```java
package com.example.security.config;

import com.example.security.entity.User;
import com.example.security.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@RequiredArgsConstructor
public class TestDataInitializer implements CommandLineRunner {

    private final UserService userService;

    @Override
    public void run(String... args) throws Exception {
        // 테스트 사용자 생성 (관리자 계정은 schema.sql에서 생성)
        if (!userService.findAllUsers().isEmpty()) {
            return;
        }

        User testUser = User.builder()
                .username("user")
                .password("user123") // 암호화됨
                .email("user@example.com")
                .name("Test User")
                .roles(List.of("USER"))
                .build();

        userService.registerUser(testUser);

        System.out.println("테스트 데이터 생성 완료");
    }
}
```

## 주요 변경 사항

1. **JPA → MyBatis**: Mapper 인터페이스와 XML로 데이터 액세스 계층 구현
2. **H2 → MySQL**: 프로덕션 환경에 적합한 MySQL 데이터베이스 사용
3. **엔티티 매핑**: MyBatis 결과 매핑을 위한 ResultMap 정의
4. **트랜잭션 관리**: `@Transactional` 어노테이션 추가
5. **SQL 분리**: 모든 SQL 쿼리를 XML 파일로 분리

이제 MySQL 데이터베이스를 준비하고 application.yml에서 연결 정보를 수정하면 MyBatis 기반의 Spring Security 회원 관리 시스템을 사용할 수 있습니다.
