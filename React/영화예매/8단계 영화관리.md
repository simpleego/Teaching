# 8단계 영화관리
> 영화 예매 사이트에 관리자 기능을 추가하여 \*\*영화를 등록, 수정, 삭제(CRUD)\*\*하는 기능을 구현하겠습니다.
> 특히 영화 등록 시 **포스터 이미지를 직접 업로드**하는 기능을 포함하여 8단계를 진행하겠습니다.

이번 단계는 백엔드에서 파일 업로드를 처리하는 `multer` 라이브러리를 사용하고, 프론트엔드에서는 `FormData` 객체를 이용하여 파일과 텍스트 데이터를 함께 서버로 전송하는 방법을 배우게 됩니다.

-----

### **[1부] ⚙️ Node.js 백엔드: 영화 CRUD 및 파일 업로드 API 구현**

먼저 `movie-api-server`에 파일 업로드를 처리하고, 영화를 생성, 수정, 삭제하는 API를 추가합니다.

**1. `multer` 라이브러리 설치**

`multer`는 `multipart/form-data`를 다루기 위한 Node.js 미들웨어로, 파일 업로드를 위해 주로 사용됩니다. **`movie-api-server` 터미널**에서 아래 명령어를 실행하여 설치합니다.

```bash
npm install multer
```

**2. `server.js` 파일 전체 수정**

기존 `server.js`를 아래의 전체 코드로 교체합니다. 영화 CRUD API와 파일 업로드 처리를 위한 로직이 모두 포함되어 있습니다.

#### `movie-api-server/server.js` (전체 코드)

```javascript
const express = require('express');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs'); // 파일 시스템 모듈

let movies = require('./movies'); // let으로 변경하여 데이터 수정이 가능하게 함
const users = require('./users');

const app = express();
const port = 5000;

// --- 미들웨어 설정 ---
app.use(cors());
app.use(express.json());

// '/uploads' 경로로 들어오는 요청에 대해 'uploads' 폴더의 정적 파일을 제공
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// --- Multer 파일 업로드 설정 ---
// 업로드된 파일을 저장할 폴더가 없으면 생성
const uploadDir = 'uploads/';
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir);
}

const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, 'uploads/'); // 파일이 저장될 경로
  },
  filename: function (req, file, cb) {
    // 파일명 중복을 피하기 위해 타임스탬프를 사용
    cb(null, Date.now() + path.extname(file.originalname));
  }
});
const upload = multer({ storage: storage });

// --- 기존 API (인증, 영화 조회) ---
// (이전 단계의 로그인, 회원가입, 영화 조회 API 코드는 여기에 그대로 존재)
// ...

// --- 새로운 영화 CRUD API ---

// API 5: 영화 등록 (포스터 이미지 업로드 포함)
app.post('/api/movies', upload.single('poster'), (req, res) => {
  const { title, genre, director, releaseDate, description } = req.body;
  
  if (!req.file) {
    return res.status(400).send('포스터 이미지를 업로드해야 합니다.');
  }

  const newId = movies.length > 0 ? Math.max(...movies.map(m => m.id)) + 1 : 1;
  const newMovie = {
    id: newId,
    title,
    genre,
    director,
    releaseDate,
    description,
    poster: `http://localhost:5000/uploads/${req.file.filename}` // 이미지 파일 경로
  };

  movies.push(newMovie);
  res.status(201).json(newMovie);
});

// API 6: 영화 수정
app.put('/api/movies/:id', upload.single('poster'), (req, res) => {
  const movieId = parseInt(req.params.id);
  const movieIndex = movies.findIndex(m => m.id === movieId);

  if (movieIndex === -1) {
    return res.status(404).send('영화를 찾을 수 없습니다.');
  }

  const { title, genre, director, releaseDate, description } = req.body;
  const updatedMovie = { ...movies[movieIndex], title, genre, director, releaseDate, description };

  // 새 포스터 이미지가 업로드된 경우에만 경로 업데이트
  if (req.file) {
    updatedMovie.poster = `http://localhost:5000/uploads/${req.file.filename}`;
    // (선택) 기존 이미지 파일 삭제 로직 추가 가능
  }

  movies[movieIndex] = updatedMovie;
  res.json(updatedMovie);
});

// API 7: 영화 삭제
app.delete('/api/movies/:id', (req, res) => {
  const movieId = parseInt(req.params.id);
  const movieIndex = movies.findIndex(m => m.id === movieId);

  if (movieIndex === -1) {
    return res.status(404).send('영화를 찾을 수 없습니다.');
  }
  
  // (선택) 서버에서 이미지 파일도 함께 삭제
  const posterUrl = movies[movieIndex].poster;
  const filename = posterUrl.split('/uploads/')[1];
  fs.unlink(path.join(uploadDir, filename), (err) => {
    if (err) console.error("Error deleting file:", err);
  });

  movies.splice(movieIndex, 1);
  res.status(200).json({ message: '영화가 성공적으로 삭제되었습니다.' });
});


// --- 서버 실행 ---
app.listen(port, () => {
  console.log(`Movie API server listening at http://localhost:${port}`);
});

```

**3. 백엔드 서버 재시작**

`Ctrl + C`로 서버를 중지하고 다시 `node server.js`를 실행하여 변경사항을 적용합니다.

-----

### **[2부] 🖥️ 리액트 프론트엔드: 관리자 페이지 구현**

이제 관리자가 영화를 관리할 수 있는 UI를 만듭니다.

**1. 관리자 페이지 및 영화 등록/수정 폼 컴포넌트 생성**

`src/pages` 폴더에 `Admin.js`, `AddMovie.js`, `EditMovie.js` 3개의 파일을 생성합니다.
`src/components` 폴더에는 재사용할 `MovieForm.js`를 생성합니다.

#### `src/pages/Admin.js` (영화 관리 페이지)

```javascript
import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import './Admin.css';

const Admin = () => {
    const [movies, setMovies] = useState([]);

    useEffect(() => {
        fetchMovies();
    }, []);

    const fetchMovies = async () => {
        const response = await fetch('http://localhost:5000/api/movies');
        const data = await response.json();
        setMovies(data);
    };

    const handleDelete = async (movieId) => {
        if (window.confirm('정말로 이 영화를 삭제하시겠습니까?')) {
            await fetch(`http://localhost:5000/api/movies/${movieId}`, {
                method: 'DELETE',
            });
            // 삭제 후 영화 목록 다시 불러오기
            fetchMovies();
        }
    };

    return (
        <div className="admin-container">
            <h1>영화 관리</h1>
            <Link to="/admin/add" className="add-movie-btn">새 영화 등록</Link>
            <table className="movie-table">
                <thead>
                    <tr>
                        <th>포스터</th>
                        <th>제목</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    {movies.map(movie => (
                        <tr key={movie.id}>
                            <td><img src={movie.poster} alt={movie.title} width="50" /></td>
                            <td>{movie.title}</td>
                            <td>
                                <Link to={`/admin/edit/${movie.id}`} className="edit-btn">수정</Link>
                                <button onClick={() => handleDelete(movie.id)} className="delete-btn">삭제</button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
};

export default Admin;
```

#### `src/components/MovieForm.js` (재사용 가능한 폼 컴포넌트)

```javascript
import React, { useState, useEffect } from 'react';

const MovieForm = ({ onSubmit, initialData = {} }) => {
    const [movie, setMovie] = useState({
        title: '',
        genre: '',
        director: '',
        releaseDate: '',
        description: '',
    });
    const [posterFile, setPosterFile] = useState(null);

    useEffect(() => {
        if (initialData.id) {
            setMovie(initialData);
        }
    }, [initialData]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setMovie(prev => ({ ...prev, [name]: value }));
    };

    const handleFileChange = (e) => {
        setPosterFile(e.target.files[0]);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const formData = new FormData();
        Object.keys(movie).forEach(key => formData.append(key, movie[key]));
        if (posterFile) {
            formData.append('poster', posterFile);
        }
        onSubmit(formData);
    };

    return (
        <form onSubmit={handleSubmit} className="movie-form">
            <input name="title" value={movie.title} onChange={handleChange} placeholder="제목" required />
            <input name="genre" value={movie.genre} onChange={handleChange} placeholder="장르" required />
            <input name="director" value={movie.director} onChange={handleChange} placeholder="감독" required />
            <input name="releaseDate" type="date" value={movie.releaseDate} onChange={handleChange} required />
            <textarea name="description" value={movie.description} onChange={handleChange} placeholder="설명" required />
            <input type="file" onChange={handleFileChange} />
            {initialData.poster && !posterFile && <img src={initialData.poster} alt="Poster" width="100" />}
            <button type="submit">{initialData.id ? '수정하기' : '등록하기'}</button>
        </form>
    );
};

export default MovieForm;
```

#### `src/pages/AddMovie.js` (영화 등록 페이지)

```javascript
import React from 'react';
import { useNavigate } from 'react-router-dom';
import MovieForm from '../components/MovieForm';
import './MovieFormPage.css';

const AddMovie = () => {
    const navigate = useNavigate();

    const handleAddMovie = async (formData) => {
        await fetch('http://localhost:5000/api/movies', {
            method: 'POST',
            body: formData, // FormData는 Content-Type을 자동으로 설정해줌
        });
        navigate('/admin');
    };

    return (
        <div className="form-page-container">
            <h1>새 영화 등록</h1>
            <MovieForm onSubmit={handleAddMovie} />
        </div>
    );
};

export default AddMovie;
```

#### `src/pages/EditMovie.js` (영화 수정 페이지)

```javascript
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import MovieForm from '../components/MovieForm';
import './MovieFormPage.css';

const EditMovie = () => {
    const { movieId } = useParams();
    const navigate = useNavigate();
    const [movie, setMovie] = useState(null);

    useEffect(() => {
        const fetchMovie = async () => {
            const response = await fetch(`http://localhost:5000/api/movies/${movieId}`);
            const data = await response.json();
            setMovie(data);
        };
        fetchMovie();
    }, [movieId]);

    const handleEditMovie = async (formData) => {
        await fetch(`http://localhost:5000/api/movies/${movieId}`, {
            method: 'PUT',
            body: formData,
        });
        navigate('/admin');
    };

    if (!movie) return <div>로딩 중...</div>;

    return (
        <div className="form-page-container">
            <h1>영화 정보 수정</h1>
            <MovieForm onSubmit={handleEditMovie} initialData={movie} />
        </div>
    );
};

export default EditMovie;
```

**2. 관리자 페이지 및 폼 스타일 추가**

`src/pages` 폴더에 `Admin.css` 와 `MovieFormPage.css`, 그리고 `src/components` 폴더에 `MovieForm.css` 를 생성하고 스타일을 적용합니다. (CSS 코드는 이전 단계들과 유사하게 작성하면 됩니다.)

**3. 라우팅 및 헤더 메뉴 추가**

`src/App.js`에 관리자 페이지 라우트를 추가하고, `Header.js`에 관리자 페이지로 이동하는 링크를 추가합니다.

#### `src/App.js`

```javascript
// ... 다른 import 구문
import Admin from './pages/Admin';
import AddMovie from './pages/AddMovie';
import EditMovie from './pages/EditMovie';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Layout />}>
          {/* ... 기존 라우트 */}
          <Route path="admin" element={<Admin />} />
          <Route path="admin/add" element={<AddMovie />} />
          <Route path="admin/edit/:movieId" element={<EditMovie />} />
        </Route>
        {/* ... */}
      </Routes>
    </BrowserRouter>
  );
}
```

#### `src/components/Header/Header.js`

`</nav>` 태그 안에 관리자 메뉴 링크를 추가합니다. (로그인 시에만 보이게 하는 등 조건부 렌더링을 적용하면 더 좋습니다.)

```javascript
// ... nav 태그 내부
<li><Link to="/movies">영화</Link></li>
<li><Link to="/reserve">예매</Link></li>
<li><Link to="/admin">관리자</Link></li> {/* 관리자 메뉴 추가 */}
{user ? (
// ...
```

-----

### **[3부] ✅ 실행 및 확인**

1.  **백엔드**와 **프론트엔드** 서버가 모두 실행 중인지 확인합니다.
2.  브라우저에서 상단 메뉴의 \*\*'관리자'\*\*를 클릭하여 영화 관리 페이지로 이동합니다.
3.  **'새 영화 등록'** 버튼을 클릭하여 영화 등록 페이지로 이동합니다.
4.  정보를 입력하고, **'파일 선택'** 버튼을 눌러 컴퓨터에 있는 포스터 이미지를 선택한 후 '등록하기'를 클릭합니다.
5.  관리자 페이지 목록에 방금 등록한 영화가 **업로드된 이미지**와 함께 표시되는지 확인합니다.
6.  **'수정'** 버튼을 눌러 정보를 변경하고, **'삭제'** 버튼으로 영화를 삭제하는 기능이 정상적으로 동작하는지 확인합니다.

이제 관리자가 직접 영화 데이터를 관리하고 포스터 이미지를 업로드하는 완전한 CRUD 기능이 사이트에 추가되었습니다\!
