# 스프링부트 서버 유니티 연동
# Spring Boot 기반 자판기 백엔드 서버

## 1. 프로젝트 구조

### build.gradle
```gradle
plugins {
    id 'org.springframework.boot' version '3.2.0'
    id 'io.spring.dependency-management' version '1.1.4'
    id 'java'
}

group = 'com.example'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '17'

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    runtimeOnly 'com.h2database:h2'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

test {
    useJUnitPlatform()
}
```

### application.yml
```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:h2:mem:vendingdb
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  h2:
    console:
      enabled: true
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  
logging:
  level:
    com.example.vendingmachine: DEBUG
```

## 2. 엔티티 클래스

### Product.java
```java
package com.example.vendingmachine.entity;

import jakarta.persistence.*;

@Entity
@Table(name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false)
    private Integer price;
    
    @Column(nullable = false)
    private Integer stock;
    
    // 기본 생성자
    public Product() {}
    
    // 생성자
    public Product(String name, Integer price, Integer stock) {
        this.name = name;
        this.price = price;
        this.stock = stock;
    }
    
    // Getter, Setter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public Integer getPrice() { return price; }
    public void setPrice(Integer price) { this.price = price; }
    
    public Integer getStock() { return stock; }
    public void setStock(Integer stock) { this.stock = stock; }
}
```

### UserBalance.java
```java
package com.example.vendingmachine.entity;

import jakarta.persistence.*;

@Entity
@Table(name = "user_balance")
public class UserBalance {
    @Id
    private Long id = 1L; // 단일 사용자 시스템
    
    @Column(nullable = false)
    private Integer balance;
    
    // 기본 생성자
    public UserBalance() {}
    
    // 생성자
    public UserBalance(Integer balance) {
        this.balance = balance;
    }
    
    // Getter, Setter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public Integer getBalance() { return balance; }
    public void setBalance(Integer balance) { this.balance = balance; }
}
```

## 3. DTO 클래스

### ProductDto.java
```java
package com.example.vendingmachine.dto;

public class ProductDto {
    private Long id;
    private String name;
    private Integer price;
    private Integer stock;
    
    // 기본 생성자
    public ProductDto() {}
    
    // 생성자
    public ProductDto(Long id, String name, Integer price, Integer stock) {
        this.id = id;
        this.name = name;
        this.price = price;
        this.stock = stock;
    }
    
    // Getter, Setter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public Integer getPrice() { return price; }
    public void setPrice(Integer price) { this.price = price; }
    
    public Integer getStock() { return stock; }
    public void setStock(Integer stock) { this.stock = stock; }
}
```

### BuyRequestDto.java
```java
package com.example.vendingmachine.dto;

public class BuyRequestDto {
    private Long productId;
    
    // 기본 생성자
    public BuyRequestDto() {}
    
    // 생성자
    public BuyRequestDto(Long productId) {
        this.productId = productId;
    }
    
    // Getter, Setter
    public Long getProductId() { return productId; }
    public void setProductId(Long productId) { this.productId = productId; }
}
```

### BuyResponseDto.java
```java
package com.example.vendingmachine.dto;

public class BuyResponseDto {
    private Boolean success;
    private String productName;
    private Integer change;
    private String message;
    
    // 기본 생성자
    public BuyResponseDto() {}
    
    // 생성자
    public BuyResponseDto(Boolean success, String productName, Integer change, String message) {
        this.success = success;
        this.productName = productName;
        this.change = change;
        this.message = message;
    }
    
    // Getter, Setter
    public Boolean getSuccess() { return success; }
    public void setSuccess(Boolean success) { this.success = success; }
    
    public String getProductName() { return productName; }
    public void setProductName(String productName) { this.productName = productName; }
    
    public Integer getChange() { return change; }
    public void setChange(Integer change) { this.change = change; }
    
    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }
}
```

### ChargeRequestDto.java
```java
package com.example.vendingmachine.dto;

public class ChargeRequestDto {
    private Integer amount;
    
    // 기본 생성자
    public ChargeRequestDto() {}
    
    // 생성자
    public ChargeRequestDto(Integer amount) {
        this.amount = amount;
    }
    
    // Getter, Setter
    public Integer getAmount() { return amount; }
    public void setAmount(Integer amount) { this.amount = amount; }
}
```

### ChargeResponseDto.java
```java
package com.example.vendingmachine.dto;

public class ChargeResponseDto {
    private Boolean success;
    private Integer newBalance;
    private String message;
    
    // 기본 생성자
    public ChargeResponseDto() {}
    
    // 생성자
    public ChargeResponseDto(Boolean success, Integer newBalance, String message) {
        this.success = success;
        this.newBalance = newBalance;
        this.message = message;
    }
    
    // Getter, Setter
    public Boolean getSuccess() { return success; }
    public void setSuccess(Boolean success) { this.success = success; }
    
    public Integer getNewBalance() { return newBalance; }
    public void setNewBalance(Integer newBalance) { this.newBalance = newBalance; }
    
    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }
}
```

## 4. Repository 인터페이스

### ProductRepository.java
```java
package com.example.vendingmachine.repository;

import com.example.vendingmachine.entity.Product;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
}
```

### UserBalanceRepository.java
```java
package com.example.vendingmachine.repository;

import com.example.vendingmachine.entity.UserBalance;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserBalanceRepository extends JpaRepository<UserBalance, Long> {
}
```

## 5. Service 클래스

### VendingMachineService.java
```java
package com.example.vendingmachine.service;

import com.example.vendingmachine.entity.Product;
import com.example.vendingmachine.entity.UserBalance;
import com.example.vendingmachine.repository.ProductRepository;
import com.example.vendingmachine.repository.UserBalanceRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Service
public class VendingMachineService {
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private UserBalanceRepository userBalanceRepository;
    
    // 모든 상품 조회
    public List<Product> getAllProducts() {
        return productRepository.findAll();
    }
    
    // 잔액 조회
    public Integer getBalance() {
        Optional<UserBalance> userBalance = userBalanceRepository.findById(1L);
        return userBalance.map(UserBalance::getBalance).orElse(0);
    }
    
    // 상품 구매
    @Transactional
    public synchronized String buyProduct(Long productId) {
        Optional<Product> productOpt = productRepository.findById(productId);
        Optional<UserBalance> userBalanceOpt = userBalanceRepository.findById(1L);
        
        if (productOpt.isEmpty()) {
            return "상품을 찾을 수 없습니다.";
        }
        
        if (userBalanceOpt.isEmpty()) {
            return "사용자 정보를 찾을 수 없습니다.";
        }
        
        Product product = productOpt.get();
        UserBalance userBalance = userBalanceOpt.get();
        
        if (product.getStock() <= 0) {
            return "재고가 없습니다.";
        }
        
        if (userBalance.getBalance() < product.getPrice()) {
            return "잔액이 부족합니다.";
        }
        
        // 구매 처리
        product.setStock(product.getStock() - 1);
        userBalance.setBalance(userBalance.getBalance() - product.getPrice());
        
        productRepository.save(product);
        userBalanceRepository.save(userBalance);
        
        return "구매 성공: " + product.getName();
    }
    
    // 잔액 충전
    @Transactional
    public synchronized String chargeBalance(Integer amount) {
        if (amount <= 0) {
            return "유효하지 않은 금액입니다.";
        }
        
        Optional<UserBalance> userBalanceOpt = userBalanceRepository.findById(1L);
        UserBalance userBalance;
        
        if (userBalanceOpt.isPresent()) {
            userBalance = userBalanceOpt.get();
            userBalance.setBalance(userBalance.getBalance() + amount);
        } else {
            userBalance = new UserBalance(amount);
        }
        
        userBalanceRepository.save(userBalance);
        return "충전 성공: " + amount + "원";
    }
    
    // 초기 데이터 설정
    @Transactional
    public void initializeData() {
        // 초기 상품 데이터
        if (productRepository.count() == 0) {
            productRepository.save(new Product("콜라", 1500, 10));
            productRepository.save(new Product("사이다", 1300, 8));
            productRepository.save(new Product("물", 900, 15));
            productRepository.save(new Product("주스", 2000, 5));
        }
        
        // 초기 잔액 데이터
        if (userBalanceRepository.count() == 0) {
            userBalanceRepository.save(new UserBalance(5000));
        }
    }
}
```

## 6. Controller 클래스

### VendingMachineController.java
```java
package com.example.vendingmachine.controller;

import com.example.vendingmachine.dto.*;
import com.example.vendingmachine.entity.Product;
import com.example.vendingmachine.service.VendingMachineService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api")
@CrossOrigin(origins = "*") // CORS 설정
public class VendingMachineController {
    
    @Autowired
    private VendingMachineService vendingMachineService;
    
    // 상품 목록 조회
    @GetMapping("/products")
    public ResponseEntity<List<ProductDto>> getProducts() {
        List<Product> products = vendingMachineService.getAllProducts();
        List<ProductDto> productDtos = products.stream()
                .map(product -> new ProductDto(
                    product.getId(),
                    product.getName(),
                    product.getPrice(),
                    product.getStock()))
                .collect(Collectors.toList());
        
        return ResponseEntity.ok(productDtos);
    }
    
    // 잔액 조회
    @GetMapping("/balance")
    public ResponseEntity<BalanceResponseDto> getBalance() {
        Integer balance = vendingMachineService.getBalance();
        BalanceResponseDto response = new BalanceResponseDto(balance);
        return ResponseEntity.ok(response);
    }
    
    // 상품 구매
    @PostMapping("/buy")
    public ResponseEntity<BuyResponseDto> buyProduct(@RequestBody BuyRequestDto request) {
        String result = vendingMachineService.buyProduct(request.getProductId());
        Integer currentBalance = vendingMachineService.getBalance();
        
        BuyResponseDto response;
        if (result.startsWith("구매 성공")) {
            String productName = result.replace("구매 성공: ", "");
            response = new BuyResponseDto(true, productName, currentBalance, result);
        } else {
            response = new BuyResponseDto(false, null, currentBalance, result);
        }
        
        return ResponseEntity.ok(response);
    }
    
    // 잔액 충전
    @PostMapping("/charge")
    public ResponseEntity<ChargeResponseDto> chargeBalance(@RequestBody ChargeRequestDto request) {
        String result = vendingMachineService.chargeBalance(request.getAmount());
        Integer newBalance = vendingMachineService.getBalance();
        
        ChargeResponseDto response;
        if (result.startsWith("충전 성공")) {
            response = new ChargeResponseDto(true, newBalance, result);
        } else {
            response = new ChargeResponseDto(false, newBalance, result);
        }
        
        return ResponseEntity.ok(response);
    }
}

// BalanceResponseDto 추가
class BalanceResponseDto {
    private Integer balance;
    
    public BalanceResponseDto(Integer balance) {
        this.balance = balance;
    }
    
    public Integer getBalance() { return balance; }
    public void setBalance(Integer balance) { this.balance = balance; }
}
```

## 7. 데이터 초기화 설정

### DataInitializer.java
```java
package com.example.vendingmachine.config;

import com.example.vendingmachine.service.VendingMachineService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

@Component
public class DataInitializer implements CommandLineRunner {
    
    @Autowired
    private VendingMachineService vendingMachineService;
    
    @Override
    public void run(String... args) throws Exception {
        vendingMachineService.initializeData();
        System.out.println("초기 데이터 설정 완료");
    }
}
```

## 8. 메인 애플리케이션 클래스

### VendingMachineApplication.java
```java
package com.example.vendingmachine;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class VendingMachineApplication {
    public static void main(String[] args) {
        SpringApplication.run(VendingMachineApplication.class, args);
    }
}
```

## 9. Unity 클라이언트 수정

### VendingMachineManager.cs 수정 부분
```csharp
// 기존 코드 유지, URL만 변경
private string baseUrl = "http://localhost:8080/api";

// DTO 클래스들에 [System.Serializable] 속성 추가
[System.Serializable]
public class Product
{
    public long id; // long으로 변경
    public string name;
    public int price;
    public int stock;
}

[System.Serializable]
public class BuyRequest
{
    public long productId; // long으로 변경
}

// JSON 배열 파싱 수정
public static T[] FromJson<T>(string json)
{
    // Spring Boot는 이미 배열 형태로 반환하므로 바로 파싱
    return JsonUtility.FromJson<T[]>(json);
}
```

## 10. 실행 방법

1. **Spring Boot 서버 실행**:
   ```bash
   ./gradlew bootRun
   ```

2. **H2 콘솔 접속**: http://localhost:8080/h2-console

3. **API 엔드포인트**:
   - GET `/api/products` - 상품 목록
   - GET `/api/balance` - 잔액 조회
   - POST `/api/buy` - 상품 구매
   - POST `/api/charge` - 잔액 충전

이제 Spring Boot 기반의 자판기 백엔드 서버가 준비되었습니다. Unity 클라이언트는 기존 코드를 유지하면서 URL만 8080 포트로 변경하면 됩니다.
