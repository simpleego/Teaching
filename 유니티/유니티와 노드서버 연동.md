# 유니터 노드 서버 연동
# Unity와 백엔드 연동: 자판기 예제

간단한 자판기 시뮬레이션을 통해 Unity와 백엔드 서버 간의 연동을 구현하는 예제입니다.

## 1. 백엔드 서버 (Node.js + Express)

### package.json
```json
{
  "name": "vending-machine-backend",
  "version": "1.0.0",
  "description": "자판기 백엔드 서버",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5"
  }
}
```

### server.js
```javascript
const express = require('express');
const cors = require('cors');

const app = express();
const PORT = 3000;

app.use(cors());
app.use(express.json());

// 자판기 상품 데이터
let products = [
  { id: 1, name: "콜라", price: 1500, stock: 10 },
  { id: 2, name: "사이다", price: 1300, stock: 8 },
  { id: 3, name: "물", price: 900, stock: 15 },
  { id: 4, name: "주스", price: 2000, stock: 5 }
];

// 사용자 잔액
let userBalance = 5000;

// 상품 목록 조회
app.get('/api/products', (req, res) => {
  res.json(products);
});

// 잔액 조회
app.get('/api/balance', (req, res) => {
  res.json({ balance: userBalance });
});

// 상품 구매
app.post('/api/buy', (req, res) => {
  const { productId } = req.body;
  
  const product = products.find(p => p.id === productId);
  
  if (!product) {
    return res.status(404).json({ error: '상품을 찾을 수 없습니다.' });
  }
  
  if (product.stock <= 0) {
    return res.status(400).json({ error: '재고가 없습니다.' });
  }
  
  if (userBalance < product.price) {
    return res.status(400).json({ error: '잔액이 부족합니다.' });
  }
  
  // 구매 처리
  product.stock--;
  userBalance -= product.price;
  
  res.json({
    success: true,
    productName: product.name,
    change: userBalance
  });
});

// 잔액 충전
app.post('/api/charge', (req, res) => {
  const { amount } = req.body;
  
  if (amount <= 0) {
    return res.status(400).json({ error: '유효하지 않은 금액입니다.' });
  }
  
  userBalance += amount;
  
  res.json({
    success: true,
    newBalance: userBalance
  });
});

app.listen(PORT, () => {
  console.log(`서버가 http://localhost:${PORT} 에서 실행 중입니다.`);
});
```

## 2. Unity 클라이언트

### VendingMachineManager.cs
```csharp
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Networking;
using System;

[Serializable]
public class Product
{
    public int id;
    public string name;
    public int price;
    public int stock;
}

[Serializable]
public class BalanceResponse
{
    public int balance;
}

[Serializable]
public class BuyRequest
{
    public int productId;
}

[Serializable]
public class BuyResponse
{
    public bool success;
    public string productName;
    public int change;
}

[Serializable]
public class ChargeRequest
{
    public int amount;
}

[Serializable]
public class ChargeResponse
{
    public bool success;
    public int newBalance;
}

public class VendingMachineManager : MonoBehaviour
{
    [Header("UI 요소")]
    public Transform productPanel;
    public GameObject productButtonPrefab;
    public Text balanceText;
    public Text messageText;
    public InputField chargeAmountInput;
    
    private string baseUrl = "http://localhost:3000/api";
    private List<Product> products = new List<Product>();
    private int currentBalance = 0;
    
    void Start()
    {
        LoadProducts();
        LoadBalance();
    }
    
    // 상품 목록 로드
    public void LoadProducts()
    {
        StartCoroutine(GetProducts());
    }
    
    // 잔액 로드
    public void LoadBalance()
    {
        StartCoroutine(GetBalance());
    }
    
    // 상품 구매
    public void BuyProduct(int productId)
    {
        StartCoroutine(PostBuy(productId));
    }
    
    // 잔액 충전
    public void ChargeBalance()
    {
        if (int.TryParse(chargeAmountInput.text, out int amount))
        {
            StartCoroutine(PostCharge(amount));
            chargeAmountInput.text = "";
        }
        else
        {
            ShowMessage("유효한 금액을 입력해주세요.");
        }
    }
    
    // 상품 목록 가져오기
    IEnumerator GetProducts()
    {
        using (UnityWebRequest www = UnityWebRequest.Get($"{baseUrl}/products"))
        {
            yield return www.SendWebRequest();
            
            if (www.result == UnityWebRequest.Result.Success)
            {
                string jsonResponse = www.downloadHandler.text;
                Product[] productArray = JsonHelper.FromJson<Product>(jsonResponse);
                products.Clear();
                products.AddRange(productArray);
                CreateProductButtons();
            }
            else
            {
                ShowMessage("상품 목록을 불러오는데 실패했습니다.");
            }
        }
    }
    
    // 잔액 가져오기
    IEnumerator GetBalance()
    {
        using (UnityWebRequest www = UnityWebRequest.Get($"{baseUrl}/balance"))
        {
            yield return www.SendWebRequest();
            
            if (www.result == UnityWebRequest.Result.Success)
            {
                string jsonResponse = www.downloadHandler.text;
                BalanceResponse response = JsonUtility.FromJson<BalanceResponse>(jsonResponse);
                currentBalance = response.balance;
                UpdateBalanceUI();
            }
            else
            {
                ShowMessage("잔액을 불러오는데 실패했습니다.");
            }
        }
    }
    
    // 상품 구매 요청
    IEnumerator PostBuy(int productId)
    {
        BuyRequest request = new BuyRequest { productId = productId };
        string json = JsonUtility.ToJson(request);
        
        using (UnityWebRequest www = UnityWebRequest.Post($"{baseUrl}/buy", "POST"))
        {
            byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(json);
            www.uploadHandler = new UploadHandlerRaw(bodyRaw);
            www.downloadHandler = new DownloadHandlerBuffer();
            www.SetRequestHeader("Content-Type", "application/json");
            
            yield return www.SendWebRequest();
            
            if (www.result == UnityWebRequest.Result.Success)
            {
                string jsonResponse = www.downloadHandler.text;
                BuyResponse response = JsonUtility.FromJson<BuyResponse>(jsonResponse);
                
                if (response.success)
                {
                    ShowMessage($"{response.productName} 구매 성공!");
                    currentBalance = response.change;
                    UpdateBalanceUI();
                    LoadProducts(); // 상품 목록 갱신
                }
            }
            else
            {
                string errorResponse = www.downloadHandler.text;
                ErrorResponse error = JsonUtility.FromJson<ErrorResponse>(errorResponse);
                ShowMessage($"구매 실패: {error.error}");
            }
        }
    }
    
    // 잔액 충전 요청
    IEnumerator PostCharge(int amount)
    {
        ChargeRequest request = new ChargeRequest { amount = amount };
        string json = JsonUtility.ToJson(request);
        
        using (UnityWebRequest www = UnityWebRequest.Post($"{baseUrl}/charge", "POST"))
        {
            byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(json);
            www.uploadHandler = new UploadHandlerRaw(bodyRaw);
            www.downloadHandler = new DownloadHandlerBuffer();
            www.SetRequestHeader("Content-Type", "application/json");
            
            yield return www.SendWebRequest();
            
            if (www.result == UnityWebRequest.Result.Success)
            {
                string jsonResponse = www.downloadHandler.text;
                ChargeResponse response = JsonUtility.FromJson<ChargeResponse>(jsonResponse);
                
                if (response.success)
                {
                    ShowMessage($"{amount}원 충전 성공!");
                    currentBalance = response.newBalance;
                    UpdateBalanceUI();
                }
            }
            else
            {
                string errorResponse = www.downloadHandler.text;
                ErrorResponse error = JsonUtility.FromJson<ErrorResponse>(errorResponse);
                ShowMessage($"충전 실패: {error.error}");
            }
        }
    }
    
    // 상품 버튼 생성
    void CreateProductButtons()
    {
        // 기존 버튼 제거
        foreach (Transform child in productPanel)
        {
            Destroy(child.gameObject);
        }
        
        // 새 버튼 생성
        foreach (Product product in products)
        {
            GameObject buttonObj = Instantiate(productButtonPrefab, productPanel);
            ProductButton productButton = buttonObj.GetComponent<ProductButton>();
            productButton.Initialize(product, this);
        }
    }
    
    // 잔액 UI 업데이트
    void UpdateBalanceUI()
    {
        balanceText.text = $"잔액: {currentBalance}원";
    }
    
    // 메시지 표시
    void ShowMessage(string message)
    {
        messageText.text = message;
        StartCoroutine(ClearMessageAfterDelay(3f));
    }
    
    IEnumerator ClearMessageAfterDelay(float delay)
    {
        yield return new WaitForSeconds(delay);
        messageText.text = "";
    }
}

// JSON 배열 파싱을 위한 헬퍼 클래스
public static class JsonHelper
{
    public static T[] FromJson<T>(string json)
    {
        string newJson = "{\"items\":" + json + "}";
        Wrapper<T> wrapper = JsonUtility.FromJson<Wrapper<T>>(newJson);
        return wrapper.items;
    }
    
    [Serializable]
    private class Wrapper<T>
    {
        public T[] items;
    }
}

[Serializable]
public class ErrorResponse
{
    public string error;
}
```

### ProductButton.cs
```csharp
using UnityEngine;
using UnityEngine.UI;

public class ProductButton : MonoBehaviour
{
    [Header("UI 요소")]
    public Text nameText;
    public Text priceText;
    public Text stockText;
    public Button buyButton;
    
    private Product product;
    private VendingMachineManager vendingMachine;
    
    public void Initialize(Product productData, VendingMachineManager manager)
    {
        product = productData;
        vendingMachine = manager;
        
        nameText.text = product.name;
        priceText.text = $"{product.price}원";
        stockText.text = $"재고: {product.stock}";
        
        buyButton.onClick.AddListener(OnBuyButtonClick);
        
        // 재고가 없으면 버튼 비활성화
        buyButton.interactable = product.stock > 0;
    }
    
    void OnBuyButtonClick()
    {
        vendingMachine.BuyProduct(product.id);
    }
}
```

## 3. 실행 방법

1. **백엔드 서버 실행**:
   ```bash
   npm install
   node server.js
   ```

2. **Unity 설정**:
   - 새로운 Unity 프로젝트 생성
   - UI 구성 (Canvas, Panel, Button, Text 등)
   - 위 스크립트들을 추가하고 UI 요소 연결
   - 빌드 및 실행

## 4. 주요 기능

- **상품 목록 조회**: GET /api/products
- **잔액 조회**: GET /api/balance  
- **상품 구매**: POST /api/buy
- **잔액 충전**: POST /api/charge

이 예제는 Unity와 백엔드 서버 간의 기본적인 HTTP 통신을 보여주며, 실제 프로젝트에서는 에러 처리, 보안, 성능 최적화 등을 추가로 고려해야 합니다.
