# μ±„ν… μ„λ²„ 
> **μ„λ²„κ°€ μ¤‘κ³„μ μ—­ν• μ„ μν–‰ν•΄μ„ ν΄λΌμ΄μ–ΈνΈ κ°„ 1λ€1 λ©”μ‹μ§€λ¥Ό μ „λ‹¬ν•λ” κµ¬μ΅°**
> μ΄κ±΄ ν”ν β€λ©”μ‹μ§€ λΌμ°ν… μ„λ²„(Message Relay Server)β€λΌκ³  λ¶€λ¥΄λ” κµ¬μ΅°μ•Ό.

κµ¬μ„±μ€:

- **μ„λ²„**  
  - μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈ μ ‘μ† ν—μ©  
  - κ° ν΄λΌμ΄μ–ΈνΈμ—κ² κ³ μ  ID λ¶€μ—¬  
  - ν΄λΌμ΄μ–ΈνΈκ°€ β€λ„κµ¬μ—κ² λ³΄λ‚Όμ§€β€ μ§€μ •ν•λ©΄ μ„λ²„κ°€ ν•΄λ‹Ή ν΄λΌμ΄μ–ΈνΈμ—κ² λ©”μ‹μ§€λ¥Ό μ „λ‹¬  

- **ν΄λΌμ΄μ–ΈνΈ**  
  - μ„λ²„μ— μ ‘μ†  
  - μμ‹ μ ID ν™•μΈ  
  - νΉμ • μƒλ€ IDλ¥Ό μ§€μ •ν•΄ λ©”μ‹μ§€ μ „μ†΅  
  - μ„λ²„κ°€ μ „λ‹¬ν•΄μ¤€ λ©”μ‹μ§€λ¥Ό μμ‹   

---

# π¦ 1) μ„λ²„ μ½”λ“ β€” μ¤‘κ³„ μ„λ²„ (relay_server.py)

```python
import socket
import threading

clients = {}  # client_id: connection
client_id_counter = 1
lock = threading.Lock()

def handle_client(conn, addr, client_id):
    print(f"[μ ‘μ†] ν΄λΌμ΄μ–ΈνΈ {client_id} ({addr}) μ—°κ²°λ¨")
    conn.sendall(f"YOUR_ID:{client_id}".encode())

    try:
        while True:
            data = conn.recv(1024)
            if not data:
                break

            msg = data.decode().strip()
            print(f"[μμ‹ ] {client_id} β†’ μ„λ²„: {msg}")

            # λ©”μ‹μ§€ ν•μ‹: TO:<id>:<message>
            if msg.startswith("TO:"):
                try:
                    _, target_id, message = msg.split(":", 2)
                    target_id = int(target_id)

                    if target_id in clients:
                        clients[target_id].sendall(f"FROM:{client_id}:{message}".encode())
                        print(f"[μ¤‘κ³„] {client_id} β†’ {target_id}: {message}")
                    else:
                        conn.sendall(f"ERROR: λ€μƒ {target_id} μ—†μ".encode())
                except:
                    conn.sendall("ERROR: λ©”μ‹μ§€ ν•μ‹ μ¤λ¥".encode())
            else:
                conn.sendall("ERROR: μ¬λ°”λ¥Έ ν•μ‹μ€ TO:<id>:<message>".encode())

    finally:
        print(f"[μΆ…λ£] ν΄λΌμ΄μ–ΈνΈ {client_id} μ—°κ²° μΆ…λ£")
        with lock:
            del clients[client_id]
        conn.close()


def main():
    global client_id_counter

    HOST = "192.168.0.27"
    PORT = 9999

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind((HOST, PORT))
        s.listen()
        print("[μ„λ²„ μ‹μ‘] ν΄λΌμ΄μ–ΈνΈ μ ‘μ† λ€κΈ° μ¤‘...")

        while True:
            conn, addr = s.accept()

            with lock:
                client_id = client_id_counter
                client_id_counter += 1
                clients[client_id] = conn

            thread = threading.Thread(target=handle_client, args=(conn, addr, client_id), daemon=True)
            thread.start()


if __name__ == "__main__":
    main()
```

---

# π© 2) ν΄λΌμ΄μ–ΈνΈ μ½”λ“ β€” μƒλ€μ—κ² λ©”μ‹μ§€ λ³΄λ‚΄κΈ° (relay_client.py)

```python
import socket
import threading

HOST = "192.168.0.27"
PORT = 9999

def receive_messages(sock):
    while True:
        data = sock.recv(1024)
        if not data:
            break
        print("\n[μ„λ²„ λ©”μ‹μ§€]", data.decode())


def main():
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        print("[μ—°κ²°λ¨] μ„λ²„μ— μ ‘μ†ν–μµλ‹λ‹¤.")

        # μ„λ²„κ°€ λ¶€μ—¬ν• ID μμ‹ 
        my_id = s.recv(1024).decode()
        print("[λ‚΄ ID]", my_id)

        # μμ‹  μ¤λ λ“ μ‹μ‘
        threading.Thread(target=receive_messages, args=(s,), daemon=True).start()

        # λ©”μ‹μ§€ μ „μ†΅ λ£¨ν”„
        while True:
            target = input("λ³΄λ‚Ό λ€μƒ ID μ…λ ¥(exit μΆ…λ£): ")
            if target.lower() == "exit":
                break

            message = input("λ³΄λ‚Ό λ©”μ‹μ§€: ")

            send_msg = f"TO:{target}:{message}"
            s.sendall(send_msg.encode())


if __name__ == "__main__":
    main()
```

---

# π§ 3) λ™μ‘ λ°©μ‹

### β” μ„λ²„
- ν΄λΌμ΄μ–ΈνΈκ°€ μ ‘μ†ν•λ©΄ ID λ¶€μ—¬  
- λ©”μ‹μ§€ ν•μ‹:  
  ```
  TO:<μƒλ€ID>:<λ©”μ‹μ§€>
  ```
- μ„λ²„λ” ν•΄λ‹Ή IDμ ν΄λΌμ΄μ–ΈνΈμ—κ² λ©”μ‹μ§€λ¥Ό μ „λ‹¬  

### β” ν΄λΌμ΄μ–ΈνΈ
- μ„λ²„λ΅λ¶€ν„° μμ‹ μ IDλ¥Ό λ°›μ  
- μƒλ€ IDλ¥Ό μ…λ ¥ν•κ³  λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄λ©΄  
- μ„λ²„κ°€ μ¤‘κ³„ν•΄μ„ μƒλ€μ—κ² μ „λ‹¬  

---

# π¦ 4) μμ‹ μ‹λ‚λ¦¬μ¤

### ν΄λΌμ΄μ–ΈνΈ A μ ‘μ† β†’ ID 1 λ¶€μ—¬  
### ν΄λΌμ΄μ–ΈνΈ B μ ‘μ† β†’ ID 2 λ¶€μ—¬  

ν΄λΌμ΄μ–ΈνΈ A μ…λ ¥:
```
λ³΄λ‚Ό λ€μƒ ID μ…λ ¥: 2
λ³΄λ‚Ό λ©”μ‹μ§€: μ•λ…• Bμ•Ό
```

ν΄λΌμ΄μ–ΈνΈ B ν™”λ©΄:
```
[μ„λ²„ λ©”μ‹μ§€] FROM:1:μ•λ…• Bμ•Ό
```

---

ν™•μ¥ μ•„μ΄λ””μ–΄ :

- 1:N λΈλ΅λ“μΊμ¤νΈ κΈ°λ¥  
- νΉμ • κ·Έλ£ΉλΌλ¦¬λ§ ν†µμ‹ ν•λ” λ£Έ(room) κΈ°λ¥  
- JSON κΈ°λ° λ©”μ‹μ§€ ν”„λ΅ν† μ½  
- UDP κΈ°λ° μ €μ§€μ—° λ©”μ‹μ§€ μ¤‘κ³„  
- Flask μ›Ή λ€μ‹λ³΄λ“μ—μ„ ν΄λΌμ΄μ–ΈνΈ λ©λ΅ ν‘μ‹  
